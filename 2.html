<html>
<head>
<style type="text/css">
*{margin:0; padding:0; font-family:helvetica, arial, sans-serif}
body{position:relative}
.credits{position:absolute; bottom : 0; left:0 }

</style>
</head>
<body>

<div class="credits">Searching for a tunnel by <a href="http://bobylito.me">@bobylito</a></div>

<div id="container">

</div>

<script id="2d-vertex-shader" type="x-shader/x-vertex">
attribute vec2 a_position;

varying highp vec2 v_textureCoord;

void main(){
  gl_Position = vec4(a_position, 0, 1);
  v_textureCoord = a_position;
}
</script>

<script id="2d-fragment-shader" type="x-shader/x-fragment">
precision mediump float;

uniform vec2  u_center;
uniform vec2  u_resolution;
uniform float u_radius;

varying highp vec2 v_textureCoord;

uniform sampler2D u_sampler;

void main(){
//  float d = distance(u_center, gl_FragCoord.xy) / u_radius;
  vec2 coord = vec2( cos( (u_radius / distance( u_center, v_textureCoord)) ) * v_textureCoord[0], 
                     sin( (u_radius / distance( u_center, v_textureCoord)) ) * v_textureCoord[1] ) * u_radius ;
  gl_FragColor = texture2D(u_sampler, coord + 0.5);
}
</script>
<script type="text/javascript">
function createShaderFromScriptElement(doc, glCtx, scriptId){
  var shaderElt   = doc.getElementById(scriptId),
      shaderSrc   = shaderElt.text,
      shaderType  = (function(ctx, t){
        if(t === "x-shader/x-vertex")
          return ctx.VERTEX_SHADER;
        else if(t === "x-shader/x-fragment")
          return ctx.FRAGMENT_SHADER;
        else 
          throw new Error("Can't guess the type of the shader with id "+scriptId);
      })(glCtx, shaderElt.type),
      shader      = glCtx.createShader(shaderType);

  glCtx.shaderSource(shader, shaderSrc);
  glCtx.compileShader(shader);

  if(!glCtx.getShaderParameter(shader, glCtx.COMPILE_STATUS)){
      console.log("shader " + shader + " failed with error : " + glCtx.getShaderInfoLog(shader));
      throw new Error("fuckit!");
  }

  return shader;
}

function texture( gl, path ){
  var texture = gl.createTexture(),
      img     = new Image();

  img.onload  = (function textureLoaded(){
    gl.bindTexture( gl.TEXTURE_2D, texture);
    gl.texImage2D( gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, img);
    gl.texParameteri( gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
    gl.texParameteri( gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR_MIPMAP_NEAREST);
    gl.generateMipmap( gl.TEXTURE_2D);
  });

  img.src = path;

  return texture;
}

  (function(container){
    var canvas  = document.createElement("canvas"),
        ctx     = canvas.getContext("experimental-webgl"),
        vShader = createShaderFromScriptElement(document, ctx, "2d-vertex-shader"),
        fShader = createShaderFromScriptElement(document, ctx, "2d-fragment-shader"),
        program = ctx.createProgram(),
        X       = window.innerWidth,
        Y       = window.innerHeight,
        tex1    = texture(ctx, "texture.jpg");

    canvas.width  = X;
    canvas.height = Y;

    ctx.viewport(0, 0, X, Y);

    ctx.attachShader(program, vShader);
    ctx.attachShader(program, fShader);

    ctx.linkProgram(program);

    ctx.useProgram(program);

    var posLoc    = ctx.getAttribLocation(program, "a_position"),
        buffer    = ctx.createBuffer(),
        centerLoc = ctx.getUniformLocation(program, "u_center"),
        resLoc    = ctx.getUniformLocation(program, "u_resolution"),
        radiusLoc = ctx.getUniformLocation(program, "u_radius"),
        REZ       = ctx.uniform2f(resLoc, X, Y);

    ctx.enableVertexAttribArray(posLoc);

    ctx.bindBuffer(ctx.ARRAY_BUFFER, buffer);
    ctx.bufferData(
      ctx.ARRAY_BUFFER,
      new Float32Array([
        -1.0, -1.0,
         1.0, -1.0,
        -1.0,  1.0,
        -1.0,  1.0,
         1.0, -1.0,
         1.0,  1.0
      ]),
      ctx.STATIC_DRAW
    );

    ctx.vertexAttribPointer(posLoc, 2, ctx.FLOAT, false, 0, 0);

    ctx.activeTexture( ctx.TEXTURE0 );
    ctx.bindTexture( ctx.TEXTURE_2D, tex1 );
    ctx.uniform1i( ctx.getUniformLocation(program, "u_sampler"), 0);

    setInterval(function(){
        var x       = 0, // Math.sin( (new Date()).getTime()/300 ),
            y       = 0, // Math.cos( (new Date()).getTime()/300 ),
            radius  = Math.cos( (new Date).getTime() / 1000) * 2,
            center  = ctx.uniform2f( centerLoc, x, y);
        ctx.uniform1f(radiusLoc, radius);
        ctx.drawArrays(ctx.TRIANGLES, 0, 6);
    }, 1000/30);

    container.appendChild(canvas);
  })(document.getElementById("container"));
</script>

</body>

</html>
